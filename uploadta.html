<!DOCTYPE html>
<html lang="vi">
<head>
Â  <meta charset="utf-8"/>
Â  <title>Upload Dá»¯ Liá»‡u</title>
Â  <meta content="width=device-width, initial-scale=1" name="viewport"/>
Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
Â  <style>
    /* CSS Ä‘Ã£ Ä‘Æ°á»£c Ä‘Æ¡n giáº£n hÃ³a */
Â  Â  body { padding-top: 70px; }
Â  Â  #importHtmlResultContainer { max-height: 350px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 5px; padding: 12px;}
Â  Â  .subject-scroll-select { max-height: 240px !important; overflow-y: auto !important; }
Â  Â  .security-section {max-width: 360px; margin-bottom: 16px;}
Â  Â  @media (max-width: 600px) {
Â  Â  Â  #importHtmlResultContainer { max-height: 210px;}
Â  Â  }
Â  Â  .import-duplicate .import-question-title,
Â  Â  .import-duplicate .import-answer,
Â  Â  .import-duplicate .import-duplicate-message {
Â  Â  Â  color: #c00!important;
Â  Â  }
Â  Â  .import-duplicate .import-answer-correct {
Â  Â  Â  color: #c00!important;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .import-question-title {
Â  Â  Â  font-weight: 500;
Â  Â  Â  color: #0d6efd;
Â  Â  }
Â  Â  .import-answer-correct {
Â  Â  Â  color: #198754;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .import-answer {
Â  Â  Â  margin-left: 2em;
Â  Â  }
Â  Â  .import-duplicate-message {
Â  Â  Â  color: #c00;
Â  Â  Â  font-style: italic;
Â  Â  }
Â  Â  .image-warning-text { color: #d35400; font-weight: 500; }
Â  </style>
Â  <link rel="icon" href="data:,">
Â  <script async id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-light">
<header id="navbar-placeholder"></header>

<div class="online-counter-box text-center" style="background-color: #e8f5e9; color: #2e7d32; border-left: 5px solid #4caf50; padding: 10px 16px; margin: 20px auto 10px; border-radius: 6px; max-width: 600px; font-weight: 500;">
Â  ğŸŸ¢ Hiá»‡n cÃ³ Báº¡n vÃ  <span id="online-counter">0</span> ngÆ°á»i ná»¯a Ä‘ang truy cáº­p há»‡ thá»‘ng.
</div>

<div class="container py-4">

Â  Â  <div id="importHtmlSection">
Â  Â  <h5 class="mt-3">Nháº­p cÃ¢u há»i tá»« file HTML Moodle</h5>
Â  Â  <select class="form-select mb-2 subject-scroll-select" id="subjectDropdownImport" style="max-width:350px;">
Â  Â  Â  <option value="">-- Chá»n mÃ´n há»c Ä‘á»ƒ lÆ°u --</option>
Â  Â  </select>
Â  Â  <input type="file" id="importHtmlInput" accept=".html,.htm" class="form-control mb-2" style="max-width:350px;" disabled>
Â  Â  <div id="importHtmlResultContainer">
Â  Â  Â  <div id="importHtmlResult" class="mt-3"></div>
Â  Â  </div>
Â  Â  <div class="security-section" style="margin-top:10px;">
Â  Â  Â  <input type="password" class="form-control mb-1" id="questionSecurityCodeImport" placeholder="Nháº­p mÃ£ báº£o máº­t Ä‘á»ƒ lÆ°u">
Â  Â  Â  <div id="questionSecurityCodeStatusImport" style="font-size:0.95em;" class="mb-2"></div>
Â  Â  </div>
Â  Â  <button class="btn btn-success mt-2" id="saveImportBtn" style="display:none;" disabled>ğŸ’¾ LÆ°u vÃ o CSDL</button>
Â  </div>

</div>

<script type="module">
import { getDatabase, ref, onValue, onDisconnect, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyAjBMA-atKKvecY8CWeQXZsIQ3yHckZ92c",
Â  Â  authDomain: "tracuu-d3ee9.firebaseapp.com",
Â  Â  projectId: "tracuu-d3ee9",
Â  Â  storageBucket: "tracuu-d3ee9.appspot.com",
Â  Â  messagingSenderId: "593568604435",
Â  Â  appId: "1:593568604435:web:9a5145457a8ee734143ae6",
Â  Â  measurementId: "G-R0M6Y502NP"
Â  };
Â  const app = initializeApp(firebaseConfig);
Â  const db = getFirestore(app);
Â  const rtdb = getDatabase(app, "https://tracuu-d3ee9-default-rtdb.asia-southeast1.firebasedatabase.app");

Â  const onlineCounterEl = document.getElementById('online-counter');
Â  const connectionsRef = ref(rtdb, 'connections');
Â  const myConnectionRef = push(connectionsRef);
Â  onDisconnect(myConnectionRef).remove();
Â  set(myConnectionRef, true);
Â  onValue(connectionsRef, (snapshot) => {
Â  Â  let count = 0;
Â  Â  if (snapshot.exists() && typeof snapshot.val() === 'object') {
Â  Â  Â  count = Object.keys(snapshot.val()).length;
Â  Â  }
Â  Â  onlineCounterEl.textContent = count;
Â  });

Â  async function loadSubjectsToDropdown(dropdown, allowEmpty = false) {
Â  Â  dropdown.innerHTML = allowEmpty ? `<option value="">-- Chá»n mÃ´n há»c --</option>` : "";
Â  Â  try {
Â  Â  Â  const snapshot = await getDocs(collection(db, "mon_hoc"));
Â  Â  Â  snapshot.forEach(docSnap => {
Â  Â  Â  Â  const option = document.createElement("option");
Â  Â  Â  Â  option.value = docSnap.id;
Â  Â  Â  Â  option.textContent = docSnap.data().ten_mon;
Â  Â  Â  Â  dropdown.appendChild(option);
Â  Â  Â  });
Â  Â  } catch (err) {
Â  Â  Â  console.error("Lá»—i load mÃ´n há»c:", err);
Â  Â  }
Â  }
Â  loadSubjectsToDropdown(document.getElementById("subjectDropdownImport"), true);

Â  // duplication & normalization
Â  let importedQuestions = [];
Â  let allQuestionsForSubject = [];
Â  let imagesFoundCount = 0;
Â  function normalizeCompareString(str) {
Â  Â  return (str || "").replace(/\\\([^\)]*\\\)/g, '').replace(/\[HÃŒNH áº¢NH\]/g, '').replace(/<.*?>/g, '').replace(/[\s\r\n]+/g, ' ').trim().toLowerCase();
Â  }
Â  function getNormalizedAnswers(lua_chon) {
Â  Â  return ['a','b','c','d'].map(k => normalizeCompareString(lua_chon?.[k])).filter(x => x);
Â  }
Â  function isDuplicateInSet(question, existSet) {
Â  Â  const content = normalizeCompareString(question.noi_dung);
Â  Â  const answers = getNormalizedAnswers(question.lua_chon).sort();
Â  Â  const correctContent = normalizeCompareString(question.lua_chon?.[question.dap_an_dung]);
Â  Â  for (const q of existSet) {
Â  Â  Â  const qContent = normalizeCompareString(q.noi_dung);
Â  Â  Â  const qAnswers = getNormalizedAnswers(q.lua_chon).sort();
Â  Â  Â  const qCorrectContent = normalizeCompareString(q.lua_chon?.[q.dap_an_dung]);
Â  Â  Â  if (content !== qContent) continue;
Â  Â  Â  if (answers.length !== qAnswers.length) continue;
Â  Â  Â  let allAnswersMatch = answers.every((val, index) => val === qAnswers[index]);
Â  Â  Â  if (!allAnswersMatch) continue;
Â  Â  Â  if (correctContent === qCorrectContent) return true;
Â  Â  }
Â  Â  return false;
Â  }
Â  async function loadQuestionsForSubject(mon_hoc_id) {
Â  Â  const qs = [];
Â  Â  if(!mon_hoc_id) return [];
Â  Â  try {
Â  Â  Â  const snapshot = await getDocs(query(collection(db, "cau_hoi"), where("mon_hoc_id", "==", mon_hoc_id)));
Â  Â  Â  snapshot.forEach(docSnap => { qs.push(docSnap.data()); });
Â  Â  } catch (err) {
Â  Â  Â  console.error("Lá»—i load cÃ¢u há»i:", err);
Â  Â  }
Â  Â  return qs;
Â  }

Â  const importHtmlResult = document.getElementById("importHtmlResult");
Â  const importHtmlInput = document.getElementById("importHtmlInput");
Â  const saveImportBtn = document.getElementById("saveImportBtn");
Â  const subjectDropdownImport = document.getElementById("subjectDropdownImport");

Â  // security checks
Â  let questionSecOKImport = false;
Â  document.getElementById("questionSecurityCodeImport").addEventListener("input", async function() {
Â  Â  const val = this.value.trim();
Â  Â  const statusEl = document.getElementById("questionSecurityCodeStatusImport");
Â  Â  statusEl.textContent = val ? "Äang kiá»ƒm tra..." : "";
Â  Â  questionSecOKImport = false;
Â  Â  saveImportBtn.disabled = true;
Â  Â  if (!val) { statusEl.textContent = ""; return; }
Â  Â  try {
Â  Â  Â  const docRef = doc(db, "config", "security_code");
Â  Â  Â  const snap = await getDoc(docRef);
Â  Â  Â  if (snap.exists() && snap.data().code === val) {
Â  Â  Â  Â  questionSecOKImport = true;
Â  Â  Â  Â  statusEl.innerHTML = '<span class="text-success">MÃ£ há»£p lá»‡!</span>';
Â  Â  Â  Â  if(importedQuestions.length > 0) saveImportBtn.disabled = false;
Â  Â  Â  } else {
Â  Â  Â  Â  statusEl.innerHTML = '<span class="text-danger">MÃ£ khÃ´ng há»£p lá»‡!</span>';
Â  Â  Â  }
Â  Â  } catch (err) {
Â  Â  Â  console.error("Lá»—i kiá»ƒm tra mÃ£ import:", err);
Â  Â  Â  statusEl.innerHTML = '<span class="text-danger">Lá»—i kiá»ƒm tra mÃ£!</span>';
Â  Â  }
Â  });

Â  // import HTML handling
Â  subjectDropdownImport.addEventListener("change", async function() {
Â  Â  importHtmlInput.value = "";
Â  Â  importHtmlResult.innerHTML = "";
Â  Â  saveImportBtn.style.display = "none";
Â  Â  importHtmlInput.disabled = !this.value;
Â  Â  allQuestionsForSubject = this.value ? await loadQuestionsForSubject(this.value) : [];
Â  });

Â  function extractTextAndLaTeX(node) {
Â  Â  let result = "";
Â  Â  if (!node) return result;
Â  Â  node.childNodes.forEach(child => {
Â  Â  Â  if (child.nodeType === Node.TEXT_NODE) {
Â  Â  Â  Â  result += child.textContent;
Â  Â  Â  } else if (child.nodeType === Node.ELEMENT_NODE) {
Â  Â  Â  Â  if (child.classList && (
Â  Â  Â  Â  Â  Â  child.classList.contains('answer') || 
Â  Â  Â  Â  Â  Â  child.classList.contains('outcome') || 
Â  Â  Â  Â  Â  Â  child.classList.contains('specificfeedback')
Â  Â  Â  Â  )) {
Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }
Â  Â  Â  Â  if (child.tagName === 'SCRIPT' && child.type && child.type.startsWith('math/tex')) {
Â  Â  Â  Â  Â  result += `\\(${child.textContent.trim()}\\)`;
Â  Â  Â  Â  } else if (child.tagName === 'SPAN' && (child.classList.contains('MathJax_Preview') || child.classList.contains('MathJax'))) {
Â  Â  Â  Â  Â  // ignore MathJax preview nodes
Â  Â  Â  Â  } else if (child.tagName === 'IMG' && child.src) {
Â  Â  Â  Â  Â  imagesFoundCount++;
Â  Â  Â  Â  Â  result += `<span class="image-warning-text">[HÃŒNH áº¢NH]</span>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  result += extractTextAndLaTeX(child); 
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  Â  return result.replace(/\s+/g, ' ').trim();
Â  }

Â  importHtmlInput.addEventListener("change", async function(e) {
Â  Â  const file = e.target.files[0];
Â  Â  if (!file) return;
Â  Â  const mon_hoc_id = subjectDropdownImport.value;
Â  Â  if (!mon_hoc_id) {
Â  Â  Â  alert("Vui lÃ²ng chá»n mÃ´n há»c Ä‘á»ƒ kiá»ƒm tra trÃ¹ng láº·p!");
Â  Â  Â  return;
Â  Â  }
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = async function(event) {
Â  Â  Â  imagesFoundCount = 0;
Â  Â  Â  const html = event.target.result;
Â  Â  Â  const parser = new DOMParser();
Â  Â  Â  const docx = parser.parseFromString(html, "text/html");
Â  Â  Â  importedQuestions = [];
Â  Â  Â  let rawQuestions = [];

Â  Â  Â  docx.querySelectorAll('.que').forEach(q => {
Â  Â  Â  Â  let qtextNode = q.querySelector('.qtext') || q.querySelector('.formulation');
Â  Â  Â  Â  let questionText = qtextNode ? extractTextAndLaTeX(qtextNode) : '';
Â  Â  Â  Â  
Â  Â  Â  Â  const answerNodes = Array.from(q.querySelectorAll('.answer > div'));
Â  Â  Â  Â  const answers = answerNodes.map(ansNode => extractTextAndLaTeX(ansNode.querySelector('label')));

Â  Â  Â  Â  let correctIdx = -1;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const rightAnswerNode = q.querySelector('.rightanswer') || q.querySelector('.outcome');
Â  Â  Â  Â  const rightAnswerText = rightAnswerNode?.innerText || '';
Â  Â  Â  Â  const match = rightAnswerText.match(/(?:The correct answer is:|CÃ¢u tráº£ lá»i Ä‘Ãºng lÃ :)\s*(.+)$/);

Â  Â  Â  Â  if (match) {
Â  Â  Â  Â  Â  const correctValue = match[1].trim();
Â  Â  Â  Â  Â  correctIdx = answers.findIndex(a => normalizeCompareString(a) === normalizeCompareString(correctValue));
Â  Â  Â  Â  }
Â  Â  Â  Â  if (correctIdx === -1) {
Â  Â  Â  Â  Â  correctIdx = answerNodes.findIndex(node => node.classList.contains('correct'));
Â  Â  Â  Â  }
Â  Â  Â  Â  const correctKey = correctIdx !== -1 ? ['a','b','c','d'][correctIdx] : '';

Â  Â  Â  Â  // Kiá»ƒm tra xem cÃ¢u há»i cÃ³ text khÃ´ng vÃ  cÃ³ Ã­t nháº¥t 2 lá»±a chá»n + Ä‘Ã¡p Ã¡n Ä‘Ãºng
Â  Â  Â  Â  if (questionText && answers.filter(a => a).length >= 2 && correctKey) {
Â  Â  Â  Â  Â  rawQuestions.push({
Â  Â  Â  Â  Â  Â  questionText, answers, correctIdx, correctKey,
Â  Â  Â  Â  Â  Â  lua_chon: { a: answers[0]||"", b: answers[1]||"", c: answers[2]||"", d: answers[3]||"" }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  const tempExistSet = [...allQuestionsForSubject];
Â  Â  Â  importedQuestions = rawQuestions.map(q => {
Â  Â  Â  Â  const isDup = isDuplicateInSet({ noi_dung: q.questionText, dap_an_dung: q.correctKey, lua_chon: q.lua_chon }, tempExistSet);
Â  Â  Â  Â  if(!isDup) tempExistSet.push({ noi_dung: q.questionText, dap_an_dung: q.correctKey, lua_chon: q.lua_chon });
Â  Â  Â  Â  return { ...q, duplicate: isDup };
Â  Â  Â  });

Â  Â  Â  const duplicateCount = importedQuestions.filter(q => q.duplicate).length;
Â  Â  Â  let summaryMessage = `<div class="p-2 bg-light border rounded mb-2">
Â  Â  Â  Â  <b>Tá»•ng quan:</b><br/>
Â  Â  Â  Â  - TrÃ­ch xuáº¥t: <b>${importedQuestions.length}</b> cÃ¢u há»i.<br/>
Â  Â  Â  Â  - PhÃ¡t hiá»‡n: <b>${imagesFoundCount}</b> hÃ¬nh áº£nh (sáº½ bá»‹ bá» qua).<br/>
Â  Â  Â  Â  - TrÃ¹ng láº·p: <b>${duplicateCount}</b> cÃ¢u há»i (sáº½ Ä‘Æ°á»£c bá» qua).
Â  Â  Â  Â  </div>`;
Â  Â  Â  if (imagesFoundCount > 0) {
Â  Â  Â  Â  summaryMessage += `<div class="alert alert-warning small p-2"><b>LÆ°u Ã½:</b> CÃ¡c cÃ¢u há»i chá»©a <span class="image-warning-text">[HÃŒNH áº¢NH]</span> sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u kÃ¨m áº£nh.</div>`;
Â  Â  Â  }
Â  Â  Â  let htmlResult = summaryMessage;
Â  Â  Â  importedQuestions.forEach((q) => {
Â  Â  Â  Â  htmlResult += `<div class="import-question${q.duplicate ? ' import-duplicate' : ''} border-bottom pb-2 mb-2">
Â  Â  Â  Â  Â  <span class="import-question-title">${q.questionText}</span><br>`;
Â  Â  Â  Â  // Chá»‰ hiá»ƒn thá»‹ cÃ¡c lá»±a chá»n cÃ³ ná»™i dung
Â  Â  Â  Â  q.answers.forEach((a,i) => {
Â  Â  Â  Â  Â  if (a) { // Chá»‰ hiá»ƒn thá»‹ náº¿u lá»±a chá»n 'a' cÃ³ text
Â  Â  Â  Â  Â  Â  htmlResult += `<div class="import-answer${i===q.correctIdx?' import-answer-correct':''}">
Â  Â  Â  Â  Â  Â  Â  ${String.fromCharCode(97+i)}. ${a} ${i===q.correctIdx?'<span class="small"> (ÄÃ¡p Ã¡n Ä‘Ãºng)</span>':''}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(q.duplicate)
Â  Â  Â  Â  Â  htmlResult += `<div class="import-duplicate-message">[TrÃ¹ng] CÃ¢u há»i nÃ y Ä‘Ã£ cÃ³ trong CSDL vÃ  sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.</div>`;
Â  Â  Â  Â  htmlResult += `</div>`;
Â  Â  Â  });
Â  Â  Â  importHtmlResult.innerHTML = htmlResult;
Â  Â  Â  if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise();
Â  Â  Â  
Â  Â  Â  saveImportBtn.style.display = importedQuestions.length > 0 ? "inline-block" : "none";
Â  Â  Â  
Â  Â  Â  if (questionSecOKImport) saveImportBtn.disabled = false;
Â  Â  };
Â  Â  reader.readAsText(file);
Â  });

Â  // save imported questions
Â  saveImportBtn.onclick = async function() {
Â  Â  if (!questionSecOKImport) { alert("ChÆ°a xÃ¡c thá»±c mÃ£ báº£o máº­t!"); return; }
Â  Â  const mon_hoc_id = subjectDropdownImport.value;
Â  Â  const questionsToSave = importedQuestions.filter(q => !q.duplicate);
Â  Â  if(questionsToSave.length === 0) {
Â  Â  Â  alert("KhÃ´ng cÃ³ cÃ¢u há»i má»›i nÃ o Ä‘á»ƒ lÆ°u (táº¥t cáº£ Ä‘á»u bá»‹ trÃ¹ng).");
Â  Â  Â  return;
Â  Â  }
Â  Â  saveImportBtn.disabled = true;
Â  Â  saveImportBtn.textContent = "Äang lÆ°u...";
Â  Â  const securityCode = document.getElementById("questionSecurityCodeImport").value;
Â  Â  let success = 0, fail = 0;
Â  Â  for (const q of questionsToSave) {
Â  Â  Â  try {
Â  Â  Â  Â  await addDoc(collection(db, "cau_hoi"), {
Â  Â  Â  Â  Â  Â  mon_hoc_id,
Â  Â  Â  Â  Â  Â  noi_dung: q.questionText,
Â  Â  Â  Â  Â  Â  noi_dung_img: "",
Â  Â  Â  Â  Â  Â  lua_chon: q.lua_chon,
Â  Â  Â  Â  Â  Â  dap_an_dung: q.correctKey,
Â  Â  Â  Â  Â  Â  security_code: securityCode
Â  Â  Â  Â  });
Â  Â  Â  Â  success++;
Â  Â  Â  } catch(e) {
Â  Â  Â  Â  fail++;
Â  Â  Â  Â  console.error("Lá»—i khi lÆ°u cÃ¢u há»i:", e); // Chá»¯ 'g' thá»«a Ä‘Ã£ bá»‹ xÃ³a
Â  Â  Â  }
Â  Â  }
Â  Â  alert(`ÄÃ£ lÆ°u ${success} cÃ¢u há»i má»›i, bá» qua ${importedQuestions.length - success} cÃ¢u trÃ¹ng.${fail > 0 ? ` Lá»—i ${fail} cÃ¢u. Vui lÃ²ng kiá»ƒm tra Console (F12) Ä‘á»ƒ xem chi tiáº¿t.` : ''}`);
Â  Â  if (fail === 0) window.location.reload();
Â  Â  else {
Â  Â  Â  saveImportBtn.disabled = false;
Â  Â  Â  saveImportBtn.textContent = "ğŸ’¾ LÆ°u vÃ o CSDL";
Â  Â  }
Â  };
});
</script>

Â  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
Â  <script>
Â  // Táº£i ná»™i dung cá»§a file nav.html
Â  fetch('/menu.html') // Quan trá»ng: ÄÆ°á»ng dáº«n nÃ y pháº£i trá» Ä‘Ãºng file nav.html
Â  Â  .then(response => response.text())
Â  Â  .then(data => {
Â  Â  Â  // ChÃ¨n ná»™i dung menu vÃ o tháº» "navbar-placeholder"
Â  Â  Â  document.getElementById('navbar-placeholder').innerHTML = data;
Â  Â  });
Â  </script>
</body>
</html>
